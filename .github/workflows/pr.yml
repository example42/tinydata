---
name: PR tests

on: pull_request

jobs:
  static:
    name: 'Syntax validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container: puppet/puppet-dev-tools:4.x
    steps:
      - uses: actions/checkout@v3
      - name: Run static validations
        run: /usr/local/bin/pdk bundle exec rake validate lint check
        env:
          BUNDLE_WITHOUT: development:system_tests:release

  unit:
    name: 'Unit tests'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container: puppet/puppet-dev-tools:4.x
    steps:
      - uses: actions/checkout@v3
      - name: Run unit tests on current puppet
#        run: /usr/local/bin/pdk bundle exec rake spec
        run: /usr/local/bin/pdk test unit
        env:
          BUNDLE_WITHOUT: development:system_tests:release
      - name: Run unit tests on Puppet 6
        run: /usr/local/bin/pdk test unit  --puppet-version=6
        env:
          BUNDLE_WITHOUT: development:system_tests:release
      - name: Run unit tests on Puppet 5
        run: /usr/local/bin/pdk test unit --puppet-version=5
        env:
          BUNDLE_WITHOUT: development:system_tests:release
        continue-on-error: true

  acceptance:
    strategy:
      matrix:
        include:
          - os: ubuntu
            version: [22.04,20.04,18.04,16.04]
          - os: debian
            version: [11,10,9,8]
          - os: centos
            version: [8,7]
          - os: fedora
            version: [34,33,32]
          - os: opensuse
            version: [15.3]
          - os: sles
            version: [15]
          - os: oracle
            version: [8,7]
          - os: amazon
            version: [2]
          - os: windows
            version: [2019,2016]
          - os: redhat
            version: [9,8,7]
    # runs-on: ${{ matrix.os }}
    # name: "Acceptance test on ${{ matrix.os }} versions"
    runs-on: ubuntu-latest
    name: Acceptance test on Ubuntu
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v34
      - name: Install Puppet and Tiny Puppet
        run: scripts/github_tp_setup.sh
        shell: bash
      - name: Run tp tests
        run: |
          changedfiles="${{ steps.changed-files.outputs.all_changed_files }}"
          apps=$(for a in $changedfiles ; do echo $a ; done | grep '^data' | cut -d '/' -f 2 | sort | uniq)

          for app in $apps; do
            echo "### Checking ${app}"
            sudo tp install "${app}" || test $? -eq 2
            if sudo tp test "${app}"; then
              result='success'
            else
              result='failure'
            fi
            echo "### ${app} test: ${result}!"
            echo
            echo "### ${app} info"
            sudo tp info "${app}"
            echo
            echo "### ${app} version"
            sudo tp version "${app}"
            echo
            echo "### ${app} uninstall"
            sudo tp uninstall "${app}"
            echo
          done
        shell: bash