---
name: PR tests

on: pull_request

jobs:
  validate-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Validate YAML files
        run: yamllint .

  acceptance:
    strategy:
      matrix:
        include:
          - os: ubuntu
            version: [22.04,20.04,18.04]
          - os: debian
            version: [11,10,9,8]
          - os: roboxes/centos
            version: [8,7]
#          - os: fedora
#            version: [36,35,34]
#          - os: opensuse
#            version: [15.3]
#          - os: sles
#            version: [15]
          - os: oracle
            version: [9,8,7]
#          - os: amazon
#            version: [2]
#          - os: windows
#            version: [2019,2016]
          - os: redhat
            version: [9,8,7,6]
    runs-on: ubuntu-latest
    container: ${{ matrix.os }}:${{ matrix.version }}
    name: "Acceptance test on ${{ matrix.os }} versions"
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v34
      - name: Install Puppet and Tiny Puppet
        run: scripts/github_tp_setup.sh
        shell: bash
      - name: Run tp tests
        run: scripts/github_tp_test.sh "${{ steps.changed-files.outputs.all_changed_files }}"
        shell: 'script -q -e -c "bash {0}"'
      - name: 'Upload results artifact'
        uses: actions/upload-artifact@v3
        with:
          name: my-artifact
          path: my_file.txt
          retention-days: 5