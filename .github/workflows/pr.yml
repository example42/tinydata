---
name: PR tests
on: pull_request

jobs:
  validate-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Validate YAML files
        run: yamllint .

  acceptance:
    strategy:
      matrix:
        include:
          - container: ubuntu:18.04
            pkg_install: apt-get update && apt-get install -y
          - container: ubuntu:20.04
            pkg_install: apt-get update && apt-get install -y
          - container: ubuntu:22.04
            pkg_install: apt-get update && apt-get install -y
          - container: debian:11
            pkg_install: apt-get update && apt-get install -y
          - container: debian:10
            pkg_install: apt-get update && apt-get install -y
          - container: debian:9
            pkg_install: apt-get update && apt-get install -y
          - container: debian:8
            pkg_install: apt-get update && apt-get install -y
          - container: redhat/ubi9-minimal
            pkg_install: yum install -y
          - container: redhat/ubi8-minimal
            pkg_install: yum install -y
          - container: redhat/ubi7-minimal
            pkg_install: yum install -y
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.container }}
      options: --user root
    name: "Acceptance test on ${{ matrix.container }}"
    timeout-minutes: 60
    steps:
      - name: Install Puppet, Tiny Puppet and git
        run: |
          ${{ matrix.pkg_install }} wget
          wget -O - https://bit.ly/installpuppet | bash
          mkdir -p /etc/puppetlabs/code/modules/tinydata/
          ln -s /home/runner/work/tinydata/tinydata/data /etc/puppetlabs/code/modules/tinydata/data
          puppet module install example42-tp --ignore-dependencies
          puppet module install puppetlabs-stdlib --ignore-dependencies
          puppet tp setup
          tp install git
        shell: 'script -q -e -c "bash {0}"'
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v34
      - name: Run tp tests
        run: scripts/github_tp_test.sh "${{ steps.changed-files.outputs.all_changed_files }}"
        shell: 'script -q -e -c "bash {0}"'
      - name: 'Upload results artifact'
        uses: actions/upload-artifact@v3
        with:
          name: my-artifact
          path: my_file.txt
          retention-days: 5